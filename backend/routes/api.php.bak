<?php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\AuthController;
use App\Http\Controllers\AdminController;
use App\Http\Controllers\ResidentProfileController;
use App\Http\Controllers\AnnouncementController;
use App\Http\Controllers\ResidentController;
use App\Http\Controllers\AssetController;
use App\Http\Controllers\AssetRequestController;
use App\Http\Controllers\NotificationController;
use App\Http\Controllers\BlotterRequestController;
use App\Http\Controllers\BlotterRecordsController;
use App\Http\Controllers\OrganizationalChartController;
use App\Http\Controllers\EmergencyHotlineController;
use App\Http\Controllers\DisasterEmergencyRecordController;
use App\Http\Controllers\FinancialRecordController;
use App\Http\Controllers\DocumentRequestController;
use App\Http\Controllers\ActivityLogController;
use App\Http\Controllers\StaffController;
use App\Http\Controllers\ResidencyStatusController;
use App\Http\Controllers\BeneficiaryController;

/*
|--------------------------------------------------------------------------
| Public API Routes (No Authentication Required)
|--------------------------------------------------------------------------
*/

// Test route to verify API is working
Route::get('/test-connection', function() {
    return response()->json([
        'message' => 'API connection is working',
        'timestamp' => now(),
        'server_status' => 'OK'
    ]);
});

// Search residents
Route::get('/residents/search', [ResidentController::class, 'search'])->middleware(['auth:sanctum', 'admin']);

// Restore a soft deleted resident by ID
Route::post('/residents/{id}/restore', [App\Http\Controllers\ResidentRestoreController::class, 'restore'])->middleware(['auth:sanctum', 'admin']);

// Profile fallback route for debugging (outside auth middleware)
Route::get('/profile-debug', function(Request $request) {
    $authHeader = $request->header('Authorization');
    $token = null;
    if ($authHeader && str_starts_with($authHeader, 'Bearer ')) {
        $token = substr($authHeader, 7);
    }
    
    return response()->json([
        'message' => 'Profile debug endpoint',
        'has_auth_header' => !empty($authHeader),
        'token_present' => !empty($token),
        'token_length' => $token ? strlen($token) : 0,
        'headers' => $request->headers->all(),
        'timestamp' => now()
    ]);
});

// ðŸ” Authentication
Route::post('/register', [AuthController::class, 'register']);
Route::post('/login', [AuthController::class, 'login']); // Returns Bearer token

// ðŸ” New Verification Code Routes
Route::post('/verify-registration', [AuthController::class, 'verifyRegistration']);
Route::post('/resend-verification-code', [AuthController::class, 'resendVerificationCode']);

// Test route for debugging
Route::post('/test-register', function(Request $request) {
    \Log::info('Test registration attempt:', $request->all());
    return response()->json([
        'message' => 'Test registration received',
        'data' => $request->all()
    ]);
});

// Debug registration validation
Route::post('/debug-register', function(Request $request) {
    \Log::info('Debug registration attempt:', $request->all());
    
    try {
        $validated = $request->validate([
            'name'     => 'required|string|max:255',
            'email'    => 'required|string|email|unique:users',
            'password' => 'required|string|min:8',
            'role'     => 'nullable|string|in:admin,staff,treasurer,residents',
        ]);
        
        return response()->json([
            'message' => 'Validation passed',
            'validated' => $validated
        ]);
    } catch (\Illuminate\Validation\ValidationException $e) {
        return response()->json([
            'message' => 'Validation failed',
            'errors' => $e->errors(),
            'request_data' => $request->all()
        ], 422);
    }
});

// ðŸ“§ Email Verification Routes (Legacy - keeping for compatibility)
Route::get('/email/verify/{id}/{hash}', [AuthController::class, 'verifyEmail'])->name('verification.verify');
Route::post('/email/resend', [AuthController::class, 'resendVerification'])->name('verification.resend');

// ðŸ“¢ Public Announcements (only "posted" shown to guests)
Route::get('/announcements', [AnnouncementController::class, 'index']);

// ðŸ†” Fetch individual user (used in modal selection)
Route::get('/user/{id}', function ($id) {
    $user = \App\Models\User::find($id);
    if (!$user) {
        return response()->json(['message' => 'User not found'], 404);
    }
    return response()->json(['user' => $user]);
});

// ðŸ“‹ Organizational Chart (Public)
Route::get('/organizational-chart/officials', [OrganizationalChartController::class, 'getOfficials']);
Route::get('/organizational-chart/staff', [OrganizationalChartController::class, 'getStaff']);

// ðŸ“ž Emergency Hotlines (public)
Route::get('/emergency-hotlines', [EmergencyHotlineController::class, 'index']);
Route::get('/emergency-hotlines/{id}', [EmergencyHotlineController::class, 'show']);

/*
|--------------------------------------------------------------------------
| Protected API Routes (Authenticated via Sanctum)
|--------------------------------------------------------------------------
*/
Route::middleware(['auth:sanctum', 'throttle:200,1'])->group(function () {

    // ðŸ”’ Authenticated user endpoints
    Route::post('/logout', [AuthController::class, 'logout']);
    Route::get('/user', fn(Request $request) => response()->json($request->user()));
    // Increased throttle for profile and notifications endpoints to prevent 429 errors
    Route::middleware('throttle:120,1')->group(function () {
        Route::get('/profile', [ResidentProfileController::class, 'show']);
        Route::get('/notifications', function (Request $request) {
            // Return notifications for the authenticated user
            $user = $request->user();
            $notifications = $user->notifications ?? collect();
            return response()->json([
                'notifications' => $notifications
            ]);
        });
    });

    // âœ… Mark user as having logged in
    Route::patch('/user/update-login-status', function (Request $request) {
        $user = $request->user();
        $user->has_logged_in = true;
        $user->save();

        return response()->json(['message' => 'Login status updated']);
    });

    /*
    |--------------------------------------------------------------------------
    | Admin-Only Routes
    |--------------------------------------------------------------------------
    */
    Route::middleware('admin')->prefix('admin')->group(function () {
        // Admin Profile routes
        Route::get('/profile', [\App\Http\Controllers\AdminProfileController::class, 'show']);
        Route::put('/profile', [\App\Http\Controllers\AdminProfileController::class, 'update']);

        // ðŸ§‘â€ðŸ’¼ User management
        Route::post('/register', [AuthController::class, 'register']);
        Route::delete('/user/{id}', [AuthController::class, 'deleteUser']);

        // ðŸ“Š Dashboard summary
        Route::get('/dashboard', [AdminController::class, 'index']);

        // ðŸ‘¥ Residents list
        Route::get('/residents', [ResidentProfileController::class, 'index']);
        Route::get('/admin/residents', [ResidentController::class, 'index']);
        Route::get('/residents-deleted', [ResidentController::class, 'trashed']); // Get soft deleted residents
        
        // ðŸ“Š Reporting Module - MUST come before {id} routes to avoid conflicts
        Route::get('/residents/report', [ResidentController::class, 'report']);
        Route::post('/residents/batch-check-review', [ResidentController::class, 'batchCheckReviewStatus']);
        
        Route::get('/residents/{id}', [ResidentProfileController::class, 'showById']);
        Route::put('/residents/{id}', [ResidentController::class, 'update']); // Admin update
        Route::post('/residents/{id}/delete', [ResidentController::class, 'destroy']); // Admin soft delete
        
        // ðŸ  Residency Verification
        Route::post('/residents/{id}/approve-verification', [ResidentProfileController::class, 'approveVerification']);
        Route::post('/residents/{id}/deny-verification', [ResidentProfileController::class, 'denyVerification']);

        // ðŸ“¢ Announcements full CRUD
        Route::get('/announcements', [AnnouncementController::class, 'index']); // Admin can see all announcements
        Route::apiResource('/announcements', AnnouncementController::class)->except(['index']);
        Route::patch('/announcements/{announcement}/toggle', [AnnouncementController::class, 'toggleStatus']);

        // ðŸ” Users without existing profiles
        Route::get('/users-without-profiles', [AdminController::class, 'usersWithoutProfiles']);

        // âœ… Check if user already has a profile
        Route::get('/users/{id}/has-profile', function ($id) {
            $user = \App\Models\User::with('profile')->find($id);
            if (!$user) {
                return response()->json(['message' => 'User not found.'], 404);
            }
            return response()->json(['exists' => $user->profile !== null]);
        });

        // ðŸ§‘â€ðŸ¤â€ðŸ§‘ Get all users with 'residents' role
        Route::get('/residents-users', [AdminController::class, 'residents']);

        // ðŸ“‹ Projects CRUD (Admin only)
        Route::apiResource('/projects', App\Http\Controllers\ProjectController::class);
        
        // ðŸ§‘â€ðŸ’¼ Barangay Officials & Staff Management (Admin only)
        Route::post('/officials', [OrganizationalChartController::class, 'store']);
        Route::put('/officials/{id}', [OrganizationalChartController::class, 'update']);
        Route::delete('/officials/{id}', [OrganizationalChartController::class, 'destroy']);

        // ðŸ“ Feedback management (Admin only)
        Route::apiResource('/feedbacks', App\Http\Controllers\FeedbackController::class);

        // ðŸ“ž Emergency Hotlines (admin CRUD)
        Route::post('/emergency-hotlines', [EmergencyHotlineController::class, 'store']);
        Route::put('/emergency-hotlines/{id}', [EmergencyHotlineController::class, 'update']);
        Route::delete('/emergency-hotlines/{id}', [EmergencyHotlineController::class, 'destroy']);


        Route::get('/activity-logs', [ActivityLogController::class, 'index']);
        Route::get('/activity-logs/{id}', [ActivityLogController::class, 'show']);
        Route::get('/activity-logs/statistics/summary', [ActivityLogController::class, 'statistics']);
        Route::get('/activity-logs/filters/options', [ActivityLogController::class, 'filters']);
        Route::get('/activity-logs/security/alerts', [ActivityLogController::class, 'securityAlerts']);
        Route::get('/activity-logs/audit/summary', [ActivityLogController::class, 'auditSummary']);
        Route::post('/activity-logs/export', [ActivityLogController::class, 'export']);
        Route::delete('/activity-logs/cleanup', [ActivityLogController::class, 'cleanup']);

        // Residency Status update by admin
        Route::post('/residency-status/{userId}', [ResidencyStatusController::class, 'updateStatus']);

        // Toggle My Benefits permission for a resident (admin only)
        Route::post('/residents/{id}/toggle-my-benefits', [\App\Http\Controllers\ResidentBenefitsController::class, 'toggle']);

    // ðŸ  Household management
    Route::get('/households', [\App\Http\Controllers\HouseholdController::class, 'index']);
    Route::post('/households', [\App\Http\Controllers\HouseholdController::class, 'store']);
    Route::get('/households/{id}', [\App\Http\Controllers\HouseholdController::class, 'show']);
    Route::put('/households/{id}', [\App\Http\Controllers\HouseholdController::class, 'update']);
    Route::delete('/households/{id}', [\App\Http\Controllers\HouseholdController::class, 'destroy']);
    });
    /*
    |--------------------------------------------------------------------------
    | Shared Authenticated Routes
    |--------------------------------------------------------------------------
    */

    // ðŸ‘¤ Resident: Own profile - Fixed routing
    Route::prefix('profile')->group(function () {
        Route::get('/', [ResidentProfileController::class, 'show']);
        Route::post('/update', [ResidentProfileController::class, 'update']);
        Route::put('/update', [ResidentProfileController::class, 'update']);
        Route::patch('/update', [ResidentProfileController::class, 'update']);
    });
    
    // Additional direct profile routes for compatibility
    Route::post('/profile/update', [ResidentProfileController::class, 'update']);
    Route::put('/profile/update', [ResidentProfileController::class, 'update']);
    Route::patch('/profile/update', [ResidentProfileController::class, 'update']);
    Route::post('/profile/upload-residency-verification', [ResidentProfileController::class, 'uploadResidencyVerification']);

    // ðŸ†• Resident: Complete first-time profile (Authenticated only)
    Route::post('/residents/complete-profile', [ResidentProfileController::class, 'store']);
    Route::put('/residents/complete-profile', [ResidentProfileController::class, 'store']);
    Route::get('/residents/my-profile', [ResidentController::class, 'myProfile']);

    // ðŸ§¾ Authenticated users (incl. admin): Read residents
    // Apply profile.complete middleware to protect resident-facing modules for incomplete profiles
    Route::middleware('profile.complete')->group(function () {
        Route::get('/residents', [ResidentProfileController::class, 'index']);
        Route::get('/residents/{id}', [ResidentProfileController::class, 'showById']);

        // Document Requests (resident-facing)
        Route::get('/document-requests', [App\Http\Controllers\DocumentRequestController::class, 'index']);
        Route::post('/document-requests', [App\Http\Controllers\DocumentRequestController::class, 'store']);
        Route::get('/document-requests/my', [App\Http\Controllers\DocumentRequestController::class, 'myRequests']);

        // Projects reactions and viewing
        Route::post('/projects/{projectId}/react', [App\Http\Controllers\ProjectReactionController::class, 'react']);
        Route::get('/projects/{projectId}/reactions', [App\Http\Controllers\ProjectReactionController::class, 'index']);

        // Blotter Requests (resident submit)
        Route::post('/blotter-requests', [BlotterRequestController::class, 'store']);
        
        // My Benefits API (returns placeholder data) - access controlled by mybenefits.allowed
        Route::middleware('mybenefits.allowed')->get('/my-benefits', function() {
            return response()->json([
                'message' => 'My Benefits placeholder',
                'data' => []
            ]);
        });
    });

    // ðŸ”” Notifications
    Route::get('/notifications', function (Request $request) {
        // Return notifications for the authenticated user
        $user = $request->user();
        $notifications = $user->notifications ?? collect();
        return response()->json([
            'notifications' => $notifications
        ]);
    });
    Route::patch('/notifications/{id}/read', [NotificationController::class, 'markAsRead']);

    // Assets
    Route::get('/assets', [AssetController::class, 'index']);
    Route::post('/assets', [AssetController::class, 'store']); // admin
    Route::patch('/assets/{id}', [AssetController::class, 'update']); // admin
    Route::get('/assets/{id}', [AssetController::class, 'show']);

    // Asset Requests
    Route::post('/assets/request', [AssetRequestController::class, 'store'])
        ->middleware('throttle:100,1'); // 100 requests per minute for dev
    Route::get('/asset-requests', [AssetRequestController::class, 'index']);
    // Place static routes before dynamic to avoid conflicts
    Route::get('/asset-requests/status-counts', [AssetRequestController::class, 'getStatusCounts']); // Get status counts
    Route::post('/asset-requests/generate-receipt', [AssetRequestController::class, 'generateReceipt']); // Generate PDF receipt
    Route::patch('/asset-requests/{id}', [AssetRequestController::class, 'update'])->whereNumber('id'); // admin
    Route::post('/asset-requests/{id}/pay', [AssetRequestController::class, 'processPayment'])->whereNumber('id'); // Process payment
    Route::delete('/asset-requests/{id}', [AssetRequestController::class, 'destroy'])->whereNumber('id');
    Route::get('/asset-requests/{id}', [AssetRequestController::class, 'show'])->whereNumber('id');

    // Blotter Requests
    Route::post('/blotter-requests', [BlotterRequestController::class, 'store']);

    // ðŸ“‹ Projects CRUD (Admin only)
    // Route::apiResource('/projects', App\Http\Controllers\ProjectController::class); // Moved inside admin group

    // ðŸ“ Feedback management (Admin only)
    // Route::apiResource('/feedbacks', App\Http\Controllers\FeedbackController::class); // Moved inside admin group

    // ðŸ’¬ Project Reactions (Authenticated users)
    Route::post('/projects/{projectId}/react', [App\Http\Controllers\ProjectReactionController::class, 'react']);
    Route::get('/projects/{projectId}/reactions', [App\Http\Controllers\ProjectReactionController::class, 'index']);

    // Document Requests
    Route::get('/document-requests', [App\Http\Controllers\DocumentRequestController::class, 'index']); // Admin fetch all
    Route::post('/document-requests', [App\Http\Controllers\DocumentRequestController::class, 'store']); // Resident submit
    Route::match(['put', 'patch'], '/document-requests/{id}', [App\Http\Controllers\DocumentRequestController::class, 'update']); // Admin update
    Route::get('/document-requests/my', [App\Http\Controllers\DocumentRequestController::class, 'myRequests']); // Resident view own requests
    Route::post('/document-requests/{id}/generate-pdf', [App\Http\Controllers\DocumentRequestController::class, 'generatePdf']); // Generate PDF
    Route::get('/document-requests/{id}/download-pdf', [App\Http\Controllers\DocumentRequestController::class, 'downloadPdf']); // Download PDF
    Route::get('/test-pdf', [App\Http\Controllers\DocumentRequestController::class, 'testPdf']); // Test PDF system
    
    // Photo management for document requests
    Route::get('/document-requests/{id}/photo', [App\Http\Controllers\DocumentRequestController::class, 'viewPhoto']); // View uploaded photo
    Route::get('/document-requests/{id}/download-photo', [App\Http\Controllers\DocumentRequestController::class, 'downloadPhoto']); // Download photo
    Route::delete('/document-requests/{id}/photo', [App\Http\Controllers\DocumentRequestController::class, 'deletePhoto']); // Delete photo (admin only)
});

// Direct profile update routes as fallback (outside middleware group for testing)
Route::post('/profile/update-fallback', [ResidentProfileController::class, 'update'])->middleware('auth:sanctum');
Route::put('/profile/update-fallback', [ResidentProfileController::class, 'update'])->middleware('auth:sanctum');
Route::patch('/profile/update-fallback', [ResidentProfileController::class, 'update'])->middleware('auth:sanctum');
Route::get('/profile/update', function() {
    return response()->json(['message' => 'Profile update endpoint is working. Use POST, PUT, or PATCH method to update.'], 200);
})->middleware('auth:sanctum');

// Debug route to check user profile status
Route::get('/profile/debug', function(Request $request) {
    $user = $request->user();
    $resident = \App\Models\Resident::where('user_id', $user->id)->first();
    
    return response()->json([
        'user_id' => $user->id,
        'user_email' => $user->email,
        'has_resident' => $resident ? true : false,
        'resident_id' => $resident ? $resident->id : null,
        'has_profile' => $resident && $resident->profile ? true : false,
        'profile_id' => $resident && $resident->profile ? $resident->profile->id : null,
    ]);
})->middleware('auth:sanctum');

// Additional fallback routes for profile operations (outside all middleware groups)
// These are already defined above, removing duplicates

// Debug route for profile endpoint (outside auth middleware for testing)
Route::get('/profile/test', function() {
    return response()->json([
        'message' => 'Profile endpoint is accessible',
        'timestamp' => now(),
        'auth_required' => true
    ]);
});

// Simple test route to verify API is working
Route::get('/test-api', function() {
    return response()->json([
        'message' => 'API is working!',
        'timestamp' => now(),
        'routes_available' => [
            '/profile/update',
            '/profile/update-fallback',
            '/residents/complete-profile',
            '/residents/complete-profile-fallback'
        ]
    ]);
});

Route::middleware(['auth:sanctum', 'admin'])->group(function () {
    Route::get('/admin/blotter-requests', [BlotterRequestController::class, 'index']);
    Route::patch('/blotter-requests/{id}', [BlotterRequestController::class, 'update']);
});

Route::middleware(['auth:sanctum'])->get('/blotter-requests', [BlotterRequestController::class, 'myRequests']);
Route::get('/blotter-records', [BlotterRecordsController::class, 'index']);
Route::get('/blotter-records/{id}', [BlotterRecordsController::class, 'show']);
Route::post('/blotter-records', [BlotterRecordsController::class, 'store']);

// ðŸ“‹ Projects (Read-only for all authenticated users)
Route::get('/projects', [App\Http\Controllers\ProjectController::class, 'index']);

// ðŸ“ Feedback (Residents can submit and view their own)
Route::post('/feedbacks', [App\Http\Controllers\FeedbackController::class, 'store']);
Route::get('/feedbacks/my', [App\Http\Controllers\FeedbackController::class, 'myFeedback']);
Route::get('/feedbacks', [App\Http\Controllers\FeedbackController::class, 'index']); // Allow filtering by project_id

// âœ… **New Backend Structure for Disaster/Emergency Records**
// 1. **Model:**  
// `app/Models/DisasterEmergencyRecord.php`
// - Fields: `type`, `date`, `location`, `description`, `actions_taken`, `casualties`, `reported_by`

// 2. **Migration:**  
// `database/migrations/2024_07_22_000001_create_disaster_emergency_records_table.php`
// - Table: `disaster_emergency_records`
// - Columns:  
//   - `id`
//   - `type` (e.g., Fire, Flood)
//   - `date`
//   - `location`
//   - `description`
//   - `actions_taken` (nullable)
//   - `casualties` (nullable)
//   - `reported_by` (nullable)
//   - `timestamps`

// 3. **Controller:**  
// `app/Http/Controllers/DisasterEmergencyRecordController.php`
// - CRUD methods: `index`, `show`, `store`, `update`, `destroy`
// - Validates and returns JSON

// 4. **Register routes** in `routes/api.php`:
// ```php
// use App\Http\Controllers\DisasterEmergencyRecordController;
// Route::apiResource('/disaster-emergencies', DisasterEmergencyRecordController::class);
// ```

// 5. **Frontend:**  
//    - Make your â€œAdd Disaster and Emergency recordsâ€ button open a form.
//    - POST to `/disaster-emergencies` with the required fields.

// 6. **Next Steps**
// 1. **Run the migration** to create the table:
//    ```sh
//    php artisan migrate
//    ```
// 2. **Register routes** in `routes/api.php`:
//    ```php
//    use App\Http\Controllers\DisasterEmergencyRecordController;
//    Route::apiResource('/disaster-emergencies', DisasterEmergencyRecordController::class);
//    ```
// 3. **Frontend:**  
//    - Make your â€œAdd Disaster and Emergency recordsâ€ button open a form.
//    - POST to `/disaster-emergencies` with the required fields.

// 7. **Would you like the full frontend form code, or help with the API routes?**  
//    - Let me know if you want to customize the fields further!


Route::apiResource('beneficiaries', App\Http\Controllers\BeneficiaryController::class);
Route::post('/beneficiaries/{id}/toggle-benefits', [App\Http\Controllers\BeneficiaryController::class, 'toggleMyBenefits']);
Route::get('/my-benefits', [BeneficiaryController::class, 'getMyBenefits']);
Route::apiResource('disaster-emergencies', DisasterEmergencyRecordController::class);
Route::apiResource('financial-records', FinancialRecordController::class);

// Test PDF generation
Route::get('/test-pdf', function () {
    $pdf = \Barryvdh\DomPDF\Facade\Pdf::loadView('receipts.asset-rental-receipt', [
        'assetRequest' => (object)[
            'id' => 1,
            'resident' => (object)[
                'residents_id' => 'RES-001',
                'profile' => (object)[
                    'first_name' => 'John',
                    'last_name' => 'Doe',
                    'contact_number' => '09123456789',
                    'full_address' => '123 Main St, Barangay Mamatid, Cabuyao City, Laguna'
                ]
            ],
            'items' => [
                (object)[
                    'asset' => (object)[
                        'name' => 'Tent',
                        'price' => 500
                    ],
                    'quantity' => 2,
                    'request_date' => '2023-01-01'
                ],
                (object)[
                    'asset' => (object)[
                        'name' => 'Generator',
                        'price' => 1000
                    ],
                    'quantity' => 1,
                    'request_date' => '2023-01-01'
                ]
            ]
        ],
        'receiptNumber' => 'REC-001',
        'amountPaid' => 2000
    ]);
    
    return $pdf->download('test-receipt.pdf');
});
Route::apiResource('disbursements', App\Http\Controllers\DisbursementController::class);
Route::apiResource('programs', App\Http\Controllers\ProgramController::class);
